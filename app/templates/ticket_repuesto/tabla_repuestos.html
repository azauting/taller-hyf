{% extends 'menu/sidebar.html' %}

{% macro url_for_page(p) %}
{%- set args = request.args.to_dict() -%}
{%- set _ = args.update({'page': p}) -%}
{{ url_for('taller.tabla_repuestos', **args) }}
{% endmacro %}

{% block title %}Tickets repuestos - HYF{% endblock %}
{% block header %}Panel de Control de Repuestos{% endblock %}

{% block content %}
<!-- Tarjetas resumen -->
<div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
    <!-- Tarjeta En Taller -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-hyf-accent/20 text-hyf-accent mr-3">
            <i class="fas fa-tools"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">En Taller</p>
            <p class="text-lg font-bold text-white">{{ counts_taller.get('En taller', 0) }}</p>
        </div>
    </div>

    <!-- Tarjeta Terminados -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-blue-100/20 text-blue-400 mr-3">
            <i class="fas fa-check-circle"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">Terminados</p>
            <p class="text-lg font-bold text-white">{{ counts_taller.get('Terminado', 0) }}</p>
        </div>
    </div>

    <!-- Tarjeta Entregados -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-green-100/20 text-green-400 mr-3">
            <i class="fas fa-check-double"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">Entregados</p>
            <p class="text-lg font-bold text-white">{{ counts_taller.get('Entregado', 0) }}</p>
        </div>
    </div>

    <!-- Tarjeta Cancelados -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-red-100/20 text-red-400 mr-3">
            <i class="fas fa-times-circle"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">Cancelados</p>
            <p class="text-lg font-bold text-white">{{ counts_taller.get('Cancelado', 0) }}</p>
        </div>
    </div>

    <!-- Tarjeta Pendientes de Pago -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-orange-100/20 text-orange-400 mr-3">
            <i class="fas fa-clock"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">Pendientes</p>
            <p class="text-lg font-bold text-white">{{ counts_pago.get('Pendiente', 0) }}</p>
        </div>
    </div>

    <!-- Tarjeta Pagados -->
    <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-3 border border-hyf-primary flex items-center shadow-xs hover:shadow-sm transition">
        <div class="p-2 rounded-md bg-purple-100/20 text-purple-400 mr-3">
            <i class="fas fa-check-circle"></i>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-300">Pagados</p>
            <p class="text-lg font-bold text-white">{{ counts_pago.get('Pagado', 0) }}</p>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="bg-hyf-primary rounded-xl shadow-md shadow-hyf-primary overflow-hidden">
    <!-- Barra de herramientas -->
    <form method="GET" action="{{ url_for('taller.tabla_repuestos') }}"
        class="flex flex-col sm:flex-row sm:items-center justify-between p-3 border-b border-gray-700 bg-hyf-primary rounded-t-xl gap-2">

        <a href="{{ url_for('taller.tabla_repuestos') }}"
            class="btn-reset text-white px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center justify-center hover:text-hyf-accent">
            <i class="fas fa-redo sm:mr-1"></i>
            <span class="hidden sm:inline">Resetear</span>
        </a>

        <div class="relative flex-grow sm:w-48">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400 text-sm"></i>
            </div>
            <input type="text" name="buscar" placeholder="Buscar..." value="{{ search_termino if search_termino }}"
                class="pl-9 pr-3 py-1.5 bg-hyf-secondary text-white text-sm border border-gray-700 rounded-lg focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent w-full">
        </div>

        <select name="estado_taller"
            class="border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent bg-hyf-secondary text-white">
            <option value="">Estado del repuesto</option>
            <option value="En taller" {% if estado_taller_filtro=='En taller' %}selected{% endif %}>En taller</option>
            <option value="Terminado" {% if estado_taller_filtro=='Terminado' %}selected{% endif %}>Terminado</option>
            <option value="Entregado" {% if estado_taller_filtro=='Entregado' %}selected{% endif %}>Entregado</option>
            <option value="Cancelado" {% if estado_taller_filtro=='Cancelado' %}selected{% endif %}>Cancelado</option>
        </select>

        <select name="estado_pago"
            class="border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent bg-hyf-secondary text-white">
            <option value="">Estado de pago</option>
            <option value="Pendiente" {% if estado_pago_filtro=='Pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="Pagado" {% if estado_pago_filtro=='Pagado' %}selected{% endif %}>Pagado</option>
        </select>  
        
        <!-- Campo de fecha con datepicker -->
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="far fa-calendar-alt text-gray-400"></i>
            </div>
            <input type="text" name="fecha" value="{{ fecha if fecha }}" placeholder="DD-MM-AAAA"
                class="datepicker pl-9 pr-3 py-1.5 text-sm border border-gray-700 rounded-lg focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent w-full bg-hyf-secondary text-white"
                data-date-format="d-m-Y" readonly>
        </div>

        <!-- BotÃ³n de filtrar -->
        <button type="submit"
            class="bg-hyf-accent text-black px-3 py-1.5 text-sm rounded-lg hover:bg-hyf-secondary hover:text-white transition-colors">
            <i class="fas fa-filter sm:mr-1"></i>
            <span class="hidden sm:inline">Filtrar</span>
        </button>
    </form>

    <div class="flex-grow overflow-auto bg-hyf-primary">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Repuesto
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Cliente
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Cantidad
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Fecha
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Estado
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Pago
                    </th>
                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-300 uppercase tracking-wider">
                        Acciones
                    </th>
                </tr>
            </thead>

            <tbody class="bg-hyf-primary divide-y divide-gray-700">
                {% for ticketRepuesto, cliente in ticketsRepuesto %}
                <tr class="hover:bg-gray-800 transition-colors duration-150">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8 rounded-md flex items-center justify-center mr-2 
                                {% if ticketRepuesto.estado_taller == 'En taller' %}bg-yellow-100/20 text-yellow-400
                                {% elif ticketRepuesto.estado_taller == 'Terminado' %}bg-blue-100/20 text-blue-400
                                {% elif ticketRepuesto.estado_taller == 'Entregado' %}bg-green-100/20 text-green-400
                                {% elif ticketRepuesto.estado_taller == 'Cancelado' %}bg-red-100/20 text-red-400
                                {% else %}bg-gray-100/20 text-gray-400{% endif %}">
                                <i class="fas 
                                    {% if ticketRepuesto.estado_taller == 'En taller' %}fa-tools
                                    {% elif ticketRepuesto.estado_taller == 'Terminado' %}fa-check-circle
                                    {% elif ticketRepuesto.estado_taller == 'Entregado' %}fa-check-double
                                    {% elif ticketRepuesto.estado_taller == 'Cancelado' %}fa-times-circle
                                    {% else %}fa-ban{% endif %} text-sm"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-white">{{ ticketRepuesto.tipo_repuesto | capitalize }}</div>
                                <div class="text-xs text-gray-400">#{{ ticketRepuesto.id }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-bold text-white">{{ cliente.nombre }} {{ cliente.apellido }}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-white">
                        {{ ticketRepuesto.cantidad }}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">
                        {{ ticketRepuesto.fecha_creacion.strftime('%d/%m/%y') }}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if ticketRepuesto.estado_taller == 'En taller' %}bg-yellow-100/20 text-yellow-400
                            {% elif ticketRepuesto.estado_taller == 'Terminado' %}bg-blue-100/20 text-blue-400
                            {% elif ticketRepuesto.estado_taller == 'Entregado' %}bg-green-100/20 text-green-400
                            {% elif ticketRepuesto.estado_taller == 'Cancelado' %}bg-red-100/20 text-red-400
                            {% else %}bg-gray-100/20 text-gray-400{% endif %}">
                            {{ ticketRepuesto.estado_taller }}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2.5 py-1 inline-flex text-xs font-bold rounded-full 
                            {% if ticketRepuesto.estado_pago == 'Pendiente' %}
                                bg-red-100/20 text-red-400
                            {% elif ticketRepuesto.estado_pago == 'Pagado' %}
                                bg-green-100/20 text-green-400
                                {% else %}
                                bg-gray-100/20 text-gray-400
                            {% endif %}">
                            <i class="fas 
                                {% if ticketRepuesto.estado_pago == 'Pendiente' %}fa-clock
                                {% elif ticketRepuesto.estado_pago == 'Pagado' %}fa-check-circle
                                {% else %}fa-question-circle{% endif %} mr-1 mt-0.5">
                            </i>
                            {{ ticketRepuesto.estado_pago }}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold">
                        <div class="flex justify-end space-x-2">
                            <a href="{{ url_for('ticket_repuesto.ticket_repuesto_ver', ticket_id=ticketRepuesto.id) }}"
                                class="text-xs leading-5 font-semibold text-hyf-accent bg-hyf-accent/20 py-0.5 px-2 rounded-full hover:bg-hyf-accent/30 transition-colors" title="Ver detalle">
                                <i class="fas fa-eye"></i> Ver detalle
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fas fa-box-open text-3xl text-gray-500 mb-3"></i>
                            <h3 class="text-base font-bold text-gray-300">No se encontraron tickets</h3>
                            <p class="text-sm text-gray-400 mt-1">Intenta ajustar tus filtros de bÃºsqueda</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginacion -->
    {% if total_pages > 1 %}
    <div class="bg-hyf-primary px-4 py-3 flex items-center justify-between border-t border-gray-700 rounded-b-xl">
        <div class="flex-1 flex justify-between sm:hidden">
            {% if page > 1 %}
            <a href="{{ url_for_page(page - 1) }}"
                class="relative inline-flex items-center px-3 py-1.5 border border-gray-700 text-sm font-bold rounded-md text-white bg-hyf-primary hover:bg-gray-800">
                Anterior
            </a>
            {% endif %}
            {% if page < total_pages %}
            <a href="{{ url_for_page(page + 1) }}"
                class="ml-2 relative inline-flex items-center px-3 py-1.5 border border-gray-700 text-sm font-bold rounded-md text-white bg-hyf-primary hover:bg-gray-800">
                Siguiente
            </a>
            {% endif %}
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-400">
                    Mostrando <span class="font-bold text-white">{{ (page - 1) * per_page + 1 }}</span> a
                    <span class="font-bold text-white">{{ [page * per_page, total_items]|min }}</span> de
                    <span class="font-bold text-white">{{ total_items }}</span> resultados
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if page > 1 %}
                    <a href="{{ url_for_page(page - 1) }}"
                        class="relative inline-flex items-center px-2 py-1.5 rounded-l-md border border-gray-700 bg-hyf-primary text-sm font-bold text-white hover:bg-gray-800">
                        <span class="sr-only">Anterior</span>
                        <i class="fas fa-chevron-left h-3 w-3"></i>
                    </a>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                    <a href="{{ url_for_page(p) }}"
                        class="relative inline-flex items-center px-3 py-1.5 border text-sm font-bold {% if p == page %}z-10 bg-hyf-accent border-hyf-accent text-black{% else %}bg-hyf-primary border-gray-700 text-white hover:bg-gray-800{% endif %}">
                        {{ p }}
                    </a>
                    {% endfor %}

                    {% if page < total_pages %}
                    <a href="{{ url_for_page(page + 1) }}"
                        class="relative inline-flex items-center px-2 py-1.5 rounded-r-md border border-gray-700 bg-hyf-primary text-sm font-bold text-white hover:bg-gray-800">
                        <span class="sr-only">Siguiente</span>
                        <i class="fas fa-chevron-right h-3 w-3"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ConfiguraciÃ³n del datepicker
        flatpickr(".datepicker", {
            dateFormat: "d-m-Y",
            allowInput: true,
            locale: "es",
            disableMobile: true,
            onReady: function (selectedDates, dateStr, instance) {
                instance.altInput.placeholder = "DD-MM-AAAA";
            }
        });

        // ValidaciÃ³n del formato de fecha antes de enviar el formulario
        const form = document.querySelector('form[method="GET"]');
        form.addEventListener('submit', function (e) {
            const fechaInput = form.querySelector('input[name="fecha"]');
            if (fechaInput.value && !/^\d{2}-\d{2}-\d{4}$/.test(fechaInput.value)) {
                e.preventDefault();
                alert('Por favor ingresa la fecha en formato DD-MM-AAAA');
                fechaInput.focus();
            }
        });
    });
</script>
{% endblock %}