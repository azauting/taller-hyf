{% extends 'menu/sidebar.html' %}
{% block title %}Estadísticas | HYF{% endblock %}
{% block header %}Estadísticas Financieras - HYF{% endblock %}

{% block content %}
<!-- Contenedor principal -->
<div class="bg-hyf-primary rounded-lg shadow-md shadow-hyf-primary overflow-hidden p-6">

    <!-- Sección de KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- KPI 1 - Valor del Inventario -->
        <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-4 border border-hyf-primary shadow-xs hover:shadow-sm transition">
            <div class="p-2 rounded-md bg-blue-100/20 text-blue-400 mr-3 float-left">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="ml-12">
                <p class="text-xs font-semibold text-gray-300">Valor del Inventario</p>
                <p class="text-xl font-bold text-white">${{ "{0:,.0f}".format(valor_inventario).replace(",", ".") }} CLP</p>
            </div>
        </div>
        
        <!-- KPI 2 - Tickets Servicio -->
        <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-4 border border-hyf-primary shadow-xs hover:shadow-sm transition">
            <div class="p-2 rounded-md bg-green-100/20 text-green-400 mr-3 float-left">
                <i class="fas fa-tools"></i>
            </div>
            <div class="ml-12">
                <p class="text-xs font-semibold text-gray-300">Tickets Servicio</p>
                <p class="text-xl font-bold text-white">${{ "{0:,.0f}".format(tickets_servicio).replace(",", ".") }} CLP</p>
            </div>
        </div>
        
        <!-- KPI 3 - Tickets Repuestos -->
        <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-4 border border-hyf-primary shadow-xs hover:shadow-sm transition">
            <div class="p-2 rounded-md bg-purple-100/20 text-purple-400 mr-3 float-left">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="ml-12">
                <p class="text-xs font-semibold text-gray-300">Tickets Repuestos</p>
                <p class="text-xl font-bold text-white">${{ "{0:,.0f}".format(tickets_repuestos).replace(",", ".") }} CLP</p>
            </div>
        </div>
        
        <!-- KPI 4 - Utilidad Global -->
        <div class="bg-gradient-to-br from-hyf-secondary to-hyf-primary rounded-lg p-4 border border-hyf-primary shadow-xs hover:shadow-sm transition">
            <div class="p-2 rounded-md {% if utilidad_global >= 0 %}bg-green-100/20 text-green-400{% else %}bg-red-100/20 text-red-400{% endif %} mr-3 float-left">
                <i class="fas {% if utilidad_global >= 0 %}fa-chart-line{% else %}fa-chart-bar{% endif %}"></i>
            </div>
            <div class="ml-12">
                <p class="text-xs font-semibold text-gray-300">Utilidad Global</p>
                <p class="text-xl font-bold text-white">${{ "{0:,.0f}".format(utilidad_global).replace(",", ".") }} CLP</p>
                <p class="text-xs text-gray-300 mt-1">
                    Inversión: ${{ "{0:,.0f}".format(costo_inversion).replace(",", ".") }} CLP<br>
                    Ingresos: ${{ "{0:,.0f}".format(ingresos_totales).replace(",", ".") }} CLP
                </p>
            </div>
        </div>
    </div>

    <!-- Filtros y gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Filtro por periodo -->
        <div class="bg-hyf-secondary rounded-lg p-4 border border-hyf-primary lg:col-span-1">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Filtrar por periodo</h3>
            <form method="get" action="{{ url_for('estadisticas.ver_estadisticas') }}" class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-300 mb-1">Mes</label>
                    <select name="mes" class="w-full bg-hyf-primary text-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent">
                        {% for m in range(1, 13) %}
                            <option value="{{ m }}" {% if mes == m %}selected{% endif %}>
                                {{ ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][m-1] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-300 mb-1">Año</label>
                    <select name="ano" class="w-full bg-hyf-primary text-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-hyf-accent focus:border-hyf-accent">
                        {% for y in range(2020, current_year + 1) %}
                            <option value="{{ y }}" {% if ano == y %}selected{% endif %}>
                                {{ y }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-hyf-accent text-black px-4 py-2 text-sm rounded-lg hover:bg-hyf-primary hover:text-white transition-colors">
                    <i class="fas fa-filter mr-1"></i> Filtrar
                </button>
            </form>
            
            {% if total_filtrado is not none %}
            <div class="mt-4 p-3 rounded-lg {% if total_filtrado >= 0 %}bg-green-900/30 border border-green-500/30{% else %}bg-red-900/30 border border-red-500/30{% endif %}">
                <p class="text-xs font-semibold text-gray-300">Ganancias en {{ ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][mes-1] }} {{ ano }}</p>
                <p class="text-lg font-bold {% if total_filtrado >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    ${{ "{0:,.0f}".format(total_filtrado).replace(",", ".") }} CLP
                </p>
            </div>
            {% endif %}
        </div>
        
        <!-- Gráfico de tendencia -->
        <div class="bg-hyf-secondary rounded-lg p-4 border border-hyf-primary lg:col-span-2">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Tendencia Mensual (últimos 12 meses)</h3>
            <div class="bg-hyf-primary rounded-lg p-4 h-64">
                <canvas id="tendenciaMensualChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Secciones adicionales recomendadas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Top clientes -->
        <div class="bg-hyf-secondary rounded-lg p-4 border border-hyf-primary">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Top 5 Clientes (PROXIMAMENNTE)</h3>
            <div class="overflow-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-bold text-white uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-left text-xs font-bold text-white uppercase tracking-wider">Gasto Total</th>
                            <th class="px-3 py-2 text-left text-xs font-bold text-white uppercase tracking-wider">Tickets</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <!-- Datos de ejemplo - deberías reemplazar con datos reales -->
                        <tr class="hover:bg-gray-800 transition-colors">
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-white">Cliente Ejemplo 1</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-green-400">$450.000</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-white">5</td>
                        </tr>
                        <!-- Más filas... -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Servicios más rentables -->
        <div class="bg-hyf-secondary rounded-lg p-4 border border-hyf-primary">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Servicios Más Rentables (PROXIMAMENNTE)</h3>
            <div class="space-y-3">
                <!-- Item de servicio -->
                <div class="flex justify-between items-center">
                    <span class="text-sm text-white">Cambio de aceite</span>
                    <div class="flex items-center">
                        <span class="text-sm font-bold text-green-400 mr-2">$120.000</span>
                        <span class="text-xs bg-green-900/50 text-green-300 px-2 py-0.5 rounded-full">15 ventas</span>
                    </div>
                </div>
                <!-- Más items... -->
            </div>
        </div>
    </div>

    <!-- Sección de resumen anual -->
    <div class="mt-6 bg-hyf-secondary rounded-lg p-4 border border-hyf-primary">
        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Resumen Anual {{ current_year }} (PROXIMAMENNTE)</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-hyf-primary rounded-lg p-3 text-center">
                <p class="text-xs font-semibold text-gray-300">Ingresos Totales</p>
                <p class="text-lg font-bold text-green-400">$5.240.000</p>
            </div>
            <div class="bg-hyf-primary rounded-lg p-3 text-center">
                <p class="text-xs font-semibold text-gray-300">Gastos Totales</p>
                <p class="text-lg font-bold text-red-400">$3.120.000</p>
            </div>
            <div class="bg-hyf-primary rounded-lg p-3 text-center">
                <p class="text-xs font-semibold text-gray-300">Utilidad Neta</p>
                <p class="text-lg font-bold text-blue-400">$2.120.000</p>
            </div>
            <div class="bg-hyf-primary rounded-lg p-3 text-center">
                <p class="text-xs font-semibold text-gray-300">Margen (%)</p>
                <p class="text-lg font-bold text-purple-400">40.5%</p>
            </div>
        </div>
    </div>
</div>
<script>
<!-- Script para gráficos -->
document.addEventListener('DOMContentLoaded', function() {
    // Obtener datos para el gráfico
    fetch("{{ url_for('estadisticas.datos_grafico') }}")
        .then(response => response.json())
        .then(data => {
            // Configurar gráfico
            const ctx = document.getElementById('tendenciaMensualChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Servicios',
                            data: data.servicios,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Repuestos',
                            data: data.repuestos,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total',
                            data: data.total,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: 'rgba(255, 206, 86, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-CL');
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.raw.toLocaleString('es-CL');
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error al cargar datos del gráfico:', error);
            document.getElementById('tendenciaMensualChart').parentElement.innerHTML = 
                '<p class="text-gray-400 text-center p-4">Error al cargar el gráfico. Intente recargar la página.</p>';
        });
});
</script>
{% endblock %}